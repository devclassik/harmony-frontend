<!-- Loading Overlay -->
<app-loading-overlay
  [isVisible]="
    isLoading ||
    isCreating ||
    isDeleting ||
    isLoadingAttendees ||
    isAssigningAccommodation
  "
  [title]="getLoadingTitle()"
  [message]="getLoadingMessage()"
></app-loading-overlay>

<div class="min-h-screen p-4">
  <div class="mx-auto max-w-full">
    <!-- Tab Navigation -->
    <div class="mb-6">
      <div class="flex items-center gap-8">
        <button
          [class]="
            activeTab === 'camp-meeting'
              ? 'text-[#12C16F] border-b-2 border-[#12C16F] pb-2 cursor-pointer'
              : 'text-gray-500 pb-2 cursor-pointer'
          "
          class="flex items-center gap-2 text-sm font-medium transition-colors"
          (click)="switchToCampMeeting()"
        >
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M19,5V19H5V5H19Z"
            />
          </svg>
          Camp Meeting
        </button>
        <button
          [class]="
            activeTab === 'attendees'
              ? 'text-[#12C16F] border-b-2 border-[#12C16F] pb-2 cursor-pointer'
              : 'text-gray-500 pb-2 cursor-pointer'
          "
          class="flex items-center gap-2 text-sm font-medium transition-colors"
          (click)="switchToAttendees()"
        >
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M16,4C16.56,4 17,4.44 17,5V7H19V5C19,3.34 17.66,2 16,2C14.34,2 13,3.34 13,5V7H15V5C15,4.44 15.44,4 16,4M16,8C14.34,8 13,9.34 13,11V13H19V11C19,9.34 17.66,8 16,8M16,14C14.34,14 13,15.34 13,17V19H19V17C19,15.34 17.66,14 16,14M8,4C8.56,4 9,4.44 9,5V7H11V5C11,3.34 9.66,2 8,2C6.34,2 5,3.34 5,5V7H7V5C7,4.44 7.44,4 8,4M8,8C6.34,8 5,9.34 5,11V13H11V11C11,9.34 9.66,8 8,8M8,14C6.34,14 5,15.34 5,17V19H11V17C11,15.34 9.66,14 8,14Z"
            />
          </svg>
          Attendees
        </button>
      </div>
    </div>
    <!-- Divider Line -->
    <div class="border-b border-gray-200 mb-8"></div>

    <!-- Camp Meeting Tab Content -->
    <div *ngIf="activeTab === 'camp-meeting'" class="rounded-lg">
      <app-table
        [tableTitle]="'Camp Meeting Calendar'"
        [currentView]="'calendar'"
        [showSearch]="false"
        [showFilter]="false"
        [showStatusTab]="false"
        [showPagination]="false"
        [showViewAll]="false"
        [showSelectCheckbox]="false"
        [showButton]="shouldShowCreateButton"
        showButtonText="Create Request"
        showButtonIcon="assets/svg/add.svg"
        showButtonStyle="bg-gradient-to-r from-[#12C16F] to-[#0A8754] hover:from-[#0A8754] hover:to-[#12C16F]"
        [tableData]="[]"
        [calendarEvents]="campMeetingCalendarEvents"
        [customEventClick]="handleCalendarEventClick"
        (menuAction)="onTableMenuAction($event)"
        (showButtonActionClick)="onCreateButtonClick()"
      ></app-table>
    </div>

    <!-- Attendees Tab Content -->
    <div *ngIf="activeTab === 'attendees'" class="rounded-lg">
      <!-- Camp Meeting Selection -->
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2"
          >Select Camp Meeting</label
        >
        <select
          (change)="onMeetingSelectChange($event)"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
        >
          <option value="">Select a camp meeting</option>
          <option *ngFor="let meeting of campMeetings" [value]="meeting.id">
            {{ meeting.name || "Camp Meeting " + meeting.id }} -
            {{ meeting.startDate | date : "shortDate" }}
          </option>
        </select>
      </div>

      <!-- Attendees Table -->
      <div *ngIf="selectedMeetingForAttendees">
        <app-table
          [tableTitle]="
            'Attendees for ' +
            (selectedMeetingForAttendees.name ||
              'Camp Meeting ' + selectedMeetingForAttendees.id)
          "
          [tableHeader]="attendeesTableHeader"
          [tableData]="filteredAttendeesTableData"
          [menuItems]="attendeesMenuItems"
          [currentView]="'table'"
          [showSearch]="true"
          [showFilter]="false"
          [showStatusTab]="false"
          [showPagination]="true"
          [showViewAll]="false"
          [showButton]="false"
          (menuAction)="onTableMenuAction($event)"
          (search)="onSearchChange($event)"
        ></app-table>
      </div>

      <!-- No Meeting Selected Message -->
      <div *ngIf="!selectedMeetingForAttendees" class="text-center py-12">
        <svg
          class="mx-auto h-12 w-12 text-gray-400"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
          />
        </svg>
        <h3 class="mt-2 text-sm font-medium text-gray-900">
          No camp meeting selected
        </h3>
        <p class="mt-1 text-sm text-gray-500">
          Please select a camp meeting to view its attendees.
        </p>
      </div>
    </div>
  </div>

  <!-- Camp Meeting Details using Leave Details Component -->
  <app-leave-details
    [view]="showSlideIn || showCreateSlideOut"
    [leaveData]="
      showCreateSlideOut
        ? isEditMode
          ? selectedMeetingData
          : {}
        : getMeetingAsLeaveData()
    "
    [title]="
      showCreateSlideOut
        ? isEditMode
          ? 'Edit Pre Campmeeting'
          : 'Create Pre Campmeeting'
        : 'Pre Campmeeting Information'
    "
    [leaveType]="'Pre Campmeeting'"
    [totalLeaveDays]="0"
    [showRequestType]="false"
    [showDuration]="false"
    [showLocation]="false"
    [showEndDate]="false"
    [showSubstitution]="false"
    [showAttendees]="true"
    [isCampMeeting]="true"
    [mode]="showCreateSlideOut ? 'create' : 'view'"
    [isEditMode]="isEditMode"
    [canEdit]="shouldShowCreateButton"
    [selectedMeetingData]="selectedMeetingData"
    (close)="showCreateSlideOut ? onCreateSlideOutClose() : onSlideInClose()"
    (submit)="showCreateSlideOut ? onCreateFormSubmitted($event) : null"
    (cancel)="showCreateSlideOut ? onCreateSlideOutClose() : null"
    (edit)="onEditButtonClick($event)"
    (delete)="onDeleteButtonClick($event)"
  ></app-leave-details>

  <!-- Delete Confirmation Modal -->
  <app-confirm-prompt
    *ngIf="showDeleteConfirmation"
    title="Delete Camp Meeting"
    text="Are you sure you want to delete this camp meeting? This action cannot be undone."
    yesButtonText="Delete"
    noButtonText="Cancel"
    yesButtonColor="red"
    (confirmed)="onDeleteConfirmed($event)"
    (closed)="showDeleteConfirmation = false"
  ></app-confirm-prompt>

  <!-- Attendee Details using Employee Details Component -->
  <app-employee-details
    [view]="showAttendeeSlideOut"
    (close)="onAttendeeDetailsClose()"
    [employee]="getAttendeeForEmployeeDetails()"
    [employeeDetails]="getAttendeeForEmployeeDetails()"
    [isAttendeeView]="true"
    (assignAccommodation)="onAssignAccommodation()"
  ></app-employee-details>

  <!-- Assign Accommodation Slide-out -->
  <div
    *ngIf="showAssignAccommodationSlideOut"
    class="fixed inset-0 z-50 flex justify-end bg-[#7f7f7f63]"
  >
    <div
      class="bg-white w-full max-w-xl h-full shadow-lg p-8 overflow-y-auto relative animate-slide-in-right"
    >
      <button
        class="absolute top-6 right-6 text-gray-400 hover:text-black text-2xl"
        (click)="onAssignAccommodationClose()"
      >
        &times;
      </button>

      <!-- Header -->
      <div class="flex items-center gap-2 mb-6">
        <h2 class="text-xl font-semibold text-gray-900">
          Assign Accommodation
        </h2>
      </div>

      <div class="border-b border-gray-200 mb-8"></div>

      <!-- Form Section -->
      <div class="space-y-6">
        <h3 class="text-lg font-medium text-gray-900">
          Accommodation Information
        </h3>

        <!-- Accommodation Type and Name -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Accommodation Type</label
            >
            <select
              [(ngModel)]="assignmentFormData.accommodationType"
              (change)="
                onAccommodationSelect(assignmentFormData.accommodationType)
              "
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
              required
            >
              <option value="" disabled selected>Select Accommodation</option>
              <option
                *ngFor="let accommodation of accommodations"
                [value]="accommodation.type"
              >
                {{ accommodation.type }}
              </option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Accommodation Name</label
            >
            <input
              type="text"
              [(ngModel)]="assignmentFormData.accommodationName"
              readonly
              class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
            />
          </div>
        </div>

        <!-- Room Number and Capacity -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Room Number</label
            >
            <select
              [(ngModel)]="assignmentFormData.roomName"
              (change)="onRoomSelect(assignmentFormData.roomName)"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
              [disabled]="!selectedAccommodation"
              required
            >
              <option value="" disabled selected>Select Room</option>
              <option
                *ngFor="let room of selectedAccommodation?.rooms || []"
                [value]="room.name"
              >
                {{ room.name }}
              </option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Capacity</label
            >
            <input
              type="text"
              [(ngModel)]="assignmentFormData.capacity"
              readonly
              class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
            />
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div
        class="flex justify-end space-x-3 mt-8 pt-6 border-t border-gray-200"
      >
        <button
          (click)="onAssignAccommodationClose()"
          class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500"
        >
          Cancel
        </button>
        <button
          (click)="onAssignAccommodationSubmit(assignmentFormData)"
          class="px-4 py-2 bg-gradient-to-r from-[#12C16F] to-[#0A8754] text-white rounded-lg hover:from-[#0A8754] hover:to-[#12C16F] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
        >
          Assign Accommodation
        </button>
      </div>
    </div>
  </div>

  <!-- Confirm Prompt -->
  <app-confirm-prompt
    *ngIf="showConfirmPrompt"
    [title]="promptConfig?.title"
    [text]="promptConfig?.message"
    [yesButtonText]="promptConfig?.confirmText"
    [noButtonText]="promptConfig?.cancelText"
    (confirmed)="onConfirmAssignment()"
    (closed)="onCancelAssignment()"
  ></app-confirm-prompt>
</div>
